# Распределённый вычислитель арифметических выражений


**Разработано как проект для Я.Лицея**

<details>
<summary>Техническое задание</summary>
Мы продолжаем работать над вашим калькулятором.
Пользователь хочет считать арифметические выражения. Он вводит строку 2 + 2 * 2 и хочет получить в ответ 6. Но наши операции сложения и умножения (также деление и вычитания) выполняются "очень-очень" долго. Поэтому вариант, при котором пользователь делает http-запрос и получает в качестве ответа результат, невозможна. Более того: вычисление каждой такой операции в нашей "альтернативной реальности" занимает "гигантские" вычислительные мощности. Соответственно каждое действие мы должны уметь выполнять отдельно и масштабировать эту систему можем добавлением вычислительных мощностей в нашу систему в виде новых "машин". Поэтому пользователь может с какой-то периодичностью уточнять у сервера "не посчиталось ли выражение"? Если выражение наконец будет вычислено - то он получит результат. Помните, что некоторые части арифметического выражения можно вычислять параллельно.

Back-end часть
Состоит из 2 элементов:

Сервер, который принимает арифметическое выражение, переводит его в набор последовательных задач и обеспечивает порядок их выполнения. Далее будем называть его оркестратором.
Вычислитель, который может получить от оркестратора задачу, выполнить его и вернуть серверу результат. Далее будем называть его агентом.
Оркестратор
Сервер, который имеет следующие endpoint-ы:

Добавление вычисления арифметического выражения
curl --location 'localhost/api/v1/calculate' \
--header 'Content-Type: application/json' \
--data '{
"expression": <строка с выражение>
}'
Коды ответа: 201 - выражение принято для вычисления, 422 - невалидные данные, 500 - что-то пошло не так

Тело ответа

{
"id": <уникальный идентификатор выражения>
}
Получение списка выражений
curl --location 'localhost/api/v1/expressions'
Тело ответа

{
"expressions": [
{
"id": <идентификатор выражения>,
"status": <статус вычисления выражения>,
"result": <результат выражения>
},
{
"id": <идентификатор выражения>,
"status": <статус вычисления выражения>,
"result": <результат выражения>
}
]
}
Коды ответа:

200 - успешно получен список выражений
500 - что-то пошло не так

Получение выражения по его идентификатору

curl --location 'localhost/api/v1/expressions/:id'
Коды ответа:

200 - успешно получено выражение
404 - нет такого выражения
500 - что-то пошло не так
Тело ответа

{
"expression":
{
"id": <идентификатор выражения>,
"status": <статус вычисления выражения>,
"result": <результат выражения>
}
}
Получение задачи для выполнения
curl --location 'localhost/internal/task'
Коды ответа:

200 - успешно получена задача
404 - нет задачи
500 - что-то пошло не так
Тело ответа

{
"task":
{
"id": <идентификатор задачи>,
"arg1": <имя первого аргумента>,
"arg2": <имя второго аргумента>,
"operation": <операция>,
"operation_time": <время выполнения операции>
}
}
Прием результата обработки данных.
curl --location 'localhost/internal/task' \
--header 'Content-Type: application/json' \
--data '{
"id": 1,
"result": 2.5
}'
Коды ответа:

200 - успешно записан результат
404 - нет такой задачи
422 - невалидные данные
500 - что-то пошло не так
Время выполнения операций задается переменными среды в миллисекундах
TIME_ADDITION_MS - время выполнения операции сложения в миллисекундах
TIME_SUBTRACTION_MS - время выполнения операции вычитания в миллисекундах
TIME_MULTIPLICATIONS_MS - время выполнения операции умножения в миллисекундах
TIME_DIVISIONS_MS - время выполнения операции деления в миллисекундах

Агент
Демон, который получает выражение для вычисления с сервера, вычисляет его и отправляет на сервер результат выражения.

При старте демон запускает несколько горутин, каждая из которых выступает в роли независимого вычислителя. Количество горутин регулируется переменной среды COMPUTING_POWER

Агент обязательно общается с оркестратором по http
Агент все время приходит к оркестратору с запросом "дай задачку поработать" (в ручку GET internal/task для получения задач). Оркестратор отдаёт задачу.

Агент производит вычисление и в ручку оркестратора (POST internal/task для приема результатов обработки данных) отдаёт результат

Front-end часть
Если есть энтузиазм - то предлагаем реализовать веб-интерфейс над написанным вами API на свой вкус

Правила оформления
Проект размещен на github
Проект снабжен Readme фалом - где подробно описано, о чем проект и как им пользоваться
Проект снабжён примерами использования с помощью curl (который покрывает разные сценарии: всё хорошо, ошибки)
curl --location 'localhost/api/v1/calculate' \
--header 'Content-Type: application/json' \
--data '{
"expression": "2+2*2"
}'
Отдельным блоком в документации идёт инструкция по запуску проекта (желательно, чтобы можно было просто скопировать какую-то команду и запустить ей проект)
go run ./cmd/calc_service/...
Проект покрыт тестами
</details>

## Схема
![Схема всего проекта](/docs/schema.png)

## Примеры:
### Все примеры http запросов находятся в папке [/docs/examples](./docs/examples)

- [/docs/examples/getAllExpressions.http](./docs/examples/getAllExpressions.http) -> Пример запроса на получение всех выражений
- [/docs/examples/evaluateExpression1.http](./docs/examples/evaluateExpression1.http) -> 1 пример запроса на вычисление выражения
- [/docs/examples/evaluateExpression2.http](./docs/examples/evaluateExpression2.http) -> 2 пример запроса на вычисление выражения
- [/docs/examples/evaluateExpression3.http](./docs/examples/evaluateExpression3.http) -> 3 пример запроса на вычисление выражения

## Запуск проекта

#### Перед запуском необходимо установить [docker engine](https://docs.docker.com/engine/install/) и [docker compose](https://docs.docker.com/compose/install/)

### Настройка конфигурации

#### Установите желаемые значения для переменных среды в файле .env где:

```
COMPUTING_POWER=<кол-во горутин для вычисления в агенте>
TIME_ADDITION_MS=<время сложения в миллисекундах>
TIME_SUBTRACTION_MS=<время вычитания в миллисекундах>
TIME_MULTIPLICATION_MS=<время умножения в миллисекундах>
TIME_DIVISION_MS=<время деления в миллисекундах>
```

### Запуск
```
cd DistributedCalculator
go mod tidy
docker-compose up
```

## Примеры запросов

### Отправка выражения на вычисление


```
curl --location 'localhost:8080/api/v1/calculate' \
--header 'Content-Type: application/json' \
--data '{
"expression": <строка с выражение>
}'
```

### Ответ


```json
{
  "id": <uuid выражения>
}
```

## Статус-коды ответа

- **201** - Выражение успешно принято в работу
- **500** – Что-то пошло не так

### Получение всех выражений

```
curl --location 'localhost:8080/api/v1/expressions'
```
### Ответ

```json
{
    "expressions": [
        {
            "id": <идентификатор выражения>,
            "status": <статус вычисления выражения>,
            "result": <результат выражения>
        },
        {
            "id": <идентификатор выражения>,
            "status": <статус вычисления выражения>,
            "result": <результат выражения>
        }
    ]
}
```
## Статус-коды ответа

- **200** - Успешно получен список выражений
- **500** - Что-то пошло не так

### Получение выражения по его идентификатору

```
curl --location 'localhost/api/v1/expressions/:id'
```

### Ответ

```json
{
    "expression":
        {
            "id": <идентификатор выражения>,
            "status": <статус вычисления выражения>,
            "result": <результат выражения>
        }
}
```

## Статус-коды ответа

-  **200** - Успешно получено выражение
-  **404** - Нет такого выражения
-  **500** - Что-то пошло не так
